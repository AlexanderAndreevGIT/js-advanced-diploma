!function(){"use strict";class e{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if("Character"===new.target.name)throw new Error("it's not allowed to create class Character directly. Use extended classes: Bowman, Swordsman...");this.level=1,this.health=50,this.type=t,this.attack=null,this.defence=null,this.moveDistance=null,this.attackDistance=null,this.teamName=null,this.position=null}levelUp(){if(0===this.health)throw new Error("Нельзя повысить левел умершего");this.level+=1,this.attack=Math.max(this.attack,Math.round(this.attack*(.8+this.health/100))),this.defence=Math.max(this.defence,Math.round(this.defence*(.8+this.health/100))),this.health=this.health+80>100?100:this.health+80}from(e){this.level=e.level,this.health=e.health,this.attack=e.attack,this.defence=e.defence,this.moveDistance=e.moveDistance,this.attackDistance=e.attackDistance,this.teamName=e.teamName,this.position=e.position}}class t extends e{constructor(e){if(super(e,"bowman"),this.attack=25,this.defence=25,this.moveDistance=2,this.attackDistance=2,e>1)for(let t=1;t<e;t+=1)this.levelUp()}}class a extends e{constructor(e){if(super(e,"daemon"),this.attack=10,this.defence=40,this.moveDistance=1,this.attackDistance=4,e>1)for(let t=1;t<e;t+=1)this.levelUp()}}class s extends e{constructor(e){if(super(e,"magician"),this.attack=10,this.defence=40,this.moveDistance=1,this.attackDistance=4,e>1)for(let t=1;t<e;t+=1)this.levelUp()}}class i extends e{constructor(e){if(super(e,"swordsman"),this.attack=40,this.defence=10,this.moveDistance=4,this.attackDistance=1,e>1)for(let t=1;t<e;t+=1)this.levelUp()}}class r extends e{constructor(e){if(super(e,"undead"),this.attack=40,this.defence=10,this.moveDistance=4,this.attackDistance=1,e>1)for(let t=1;t<e;t+=1)this.levelUp()}}class h extends e{constructor(e){if(super(e,"vampire"),this.attack=25,this.defence=25,this.moveDistance=2,this.attackDistance=2,e>1)for(let t=1;t<e;t+=1)this.levelUp()}}function l(e,t){const a=e<t-1,s=Number.isInteger(e/t),i=Number.isInteger((e+1)/t);return 0===e?"top-left":e===t-1?"top-right":e===t**2-t?"bottom-left":e===t**2-1?"bottom-right":a?"top":s?"left":i?"right":e>=t**2-t?"bottom":"center"}function o(e,t){return Math.round(Math.random()*(t-e)+e)}function c(e){let l;return"bowman"===e.type?l=new t(1):"daemon"===e.type?l=new a(1):"magician"===e.type?l=new s(1):"swordsman"===e.type?l=new i(1):"undead"===e.type?l=new r(1):"vampire"===e.type&&(l=new h(1)),l.from(e),l}class n{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const t=document.createElement("div");t.classList.add("cell","map-tile",`map-tile-${l(e,this.boardSize)}`),t.addEventListener("mouseenter",(e=>this.onCellEnter(e))),t.addEventListener("mouseleave",(e=>this.onCellLeave(e))),t.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(t)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class m{constructor(t,a){if(!(t instanceof e))throw new Error("character must be instance of Character or its children");if("number"!=typeof a)throw new Error("position must be a number");this.character=t,this.position=a}}var d="prairie",g="desert",p="arctic",u="mountain";function v(e,t,a){const s=[],i=function*(e,t){for(;;)yield new(e[o(0,e.length-1)])(o(1,t))}(e,t);for(let e=0;e<a;e+=1)s.push(i.next().value);return s}class C{constructor(){this.members=[]}add(e){this.members.push(e)}deleteDead(){this.members.findIndex((e=>e.health<=0))>-1&&this.members.splice(this.members.findIndex((e=>e.health<=0)),1)}addAll(e){e.forEach((e=>{this.add(e)}))}addTeamNameToCharacter(e){this.members.forEach((t=>{t.teamName=e}))}}class S{constructor(e){this.turn="player",this.gameOver=!1,this.level=1,this.score=0,this.totalScore=e,this.playerTeam=new C,this.botTeam=new C,this.positions=[],this.theme=d}from(e){this.turn=e.turn,this.gameOver=e.gameOver,this.level=e.level,this.score=e.score,this.totalScore=e.totalScore,this.theme=e.theme;for(let t=0;t<e.positions.length;t+=1){const a=c(e.positions[t].character);"player"===a.teamName?this.playerTeam.add(a):"bot"===a.teamName&&this.botTeam.add(a)}return null}}var y="auto",f="pointer",b="crosshair",w="not-allowed";class L{constructor(e,t){this.gamePlay=e,this.stateService=t,this.selectedCharacter=null}init(){this.gamePlay.addCellEnterListener((e=>this.onCellEnter(e))),this.gamePlay.addCellLeaveListener((e=>this.onCellLeave(e))),this.gamePlay.addCellClickListener((e=>this.onCellClick(e))),this.gamePlay.addNewGameListener((()=>this.newGame())),this.gamePlay.addSaveGameListener((()=>this.saveGame())),this.gamePlay.addLoadGameListener((()=>this.loadGame())),this.loadGame(),this.gameState||this.newGame()}newGame(){const e=this.gameState&&this.gameState.totalScore?this.gameState.totalScore:0;this.gameState=new S(e),this.gamePlay.drawUi(this.gameState.theme),this.gameState.playerTeam.addAll(v([i,t],1,2)),this.gameState.playerTeam.addTeamNameToCharacter("player"),this.gameState.botTeam.addAll(v([a,r,h],1,2)),this.gameState.botTeam.addTeamNameToCharacter("bot"),this.assignPositionsToTeams(),this.positionCharacters(),this.gamePlay.redrawPositions(this.gameState.positions)}loadGame(){try{const e=this.stateService.load();e&&(this.gameState=new S(e.totalScore),this.gameState.from(e),this.gamePlay.drawUi(this.gameState.theme),this.positionCharacters(),this.gamePlay.redrawPositions(this.gameState.positions))}catch(e){n.showError(e.message)}}saveGame(){this.stateService.save(this.gameState)}assignPositionsToTeams(){const e=this.playerPositionsAtLevelStart(),t=this.botPositionsAtLevelStart();this.gameState.playerTeam.members.forEach((t=>{const a=o(0,e.length-1);t.position=e[a],e.splice(a,1)})),this.gameState.botTeam.members.forEach((e=>{const a=o(0,t.length-1);e.position=t[a],t.splice(a,1)}))}positionCharacters(){this.gameState.playerTeam.members.forEach((e=>{this.gameState.positions.push(new m(e,e.position))})),this.gameState.botTeam.members.forEach((e=>{this.gameState.positions.push(new m(e,e.position))}))}playerPositionsAtLevelStart(){const e=[],{boardSize:t}=this.gamePlay;for(let a=0;a<t**2;a+=1)(Number.isInteger(a/t)||Number.isInteger((a-1)/t))&&e.push(a);return e}botPositionsAtLevelStart(){const e=[],{boardSize:t}=this.gamePlay;for(let a=0;a<t**2;a+=1)(Number.isInteger((a+1)/t)||Number.isInteger((a+2)/t))&&e.push(a);return e}onCellEnter(e){if(this.gameState.positions.find((t=>t.position===e))){const t=this.gameState.positions.find((t=>t.position===e));this.gamePlay.showCellTooltip(L.showCharacterStats(t.character),e)}if(!this.selectedCharacter&&this.characterByCellAndTeam(e,"player")&&this.gamePlay.setCursor(f),this.selectedCharacter){const t=this.visualResponse(e);this.gamePlay.setCursor(t.cursors),this.gamePlay.selectCell(e,t.color)}}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(y),this.gamePlay.deselectCell(e),this.selectedCharacter&&this.gamePlay.selectCell(this.selectedCharacter.position)}onCellClick(e){if("player"===this.gameState.turn&&!this.gameState.gameOver){const t=this.characterByCellAndTeam(e);t?null===this.selectedCharacter?"player"===t.character.teamName?this.selectCharacter(t):n.showError("Это персонаж соперника"):e===this.selectedCharacter.position?this.deselectCharacter(e):"player"===t.character.teamName?(this.deselectCharacter(this.selectedCharacter.position),this.selectCharacter(t)):"bot"===t.character.teamName&&(this.attackIsPossiable(this.selectedCharacter.character,this.selectedCharacter.position,e)?this.attack(this.selectedCharacter,t).then((()=>{this.gameLoop()})):1===this.selectedCharacter.character.attackDistance?n.showMessage(`Персонаж ${this.selectedCharacter.character.type} может атоковать по радиусу не более 1 клетки`):n.showMessage(`Персонаж ${this.selectedCharacter.character.type} может атоковать по радиусу не более ${this.selectedCharacter.character.attackDistance} клеток`)):this.selectedCharacter&&(this.moveCharacter(this.selectedCharacter.character,e),this.gameLoop())}}gameLoop(){this.levelUp(),this.isGameOver(),this.gamePlay.redrawPositions(this.gameState.positions),"player"===this.gameState.turn?(this.selectedCharacter=null,this.gameState.turn="bot",this.botActions(this.gameState)):(this.selectedCharacter=null,this.gameState.turn="player")}botActions(){const e=[],t=this.gameState.botTeam.members,a=this.gameState.playerTeam.members;for(let s=0;s<t.length;s+=1)for(let i=0;i<a.length;i+=1)if(this.attackIsPossiable(t[s],t[s].position,a[i].position)){const r={type:"attack",attacker:t[s],target:a[i],damage:L.damage(t[s],a[i])};e.push(r)}for(let s=0;s<t.length;s+=1)for(let i=0;i<this.gamePlay.boardSize**2;i+=1)if(this.moveIsPossiable(t[s],i)&&!this.characterByCellAndTeam(i)){const r={type:"move",character:t[s],moveIndex:i};a.forEach((a=>{this.attackIsPossiable(t[s],i,a.position)&&(r.nextMoveAttack=!0,r.targetNextMove=a,r.damage=L.damage(r.character,r.targetNextMove),e.push(r))})),r.nextMoveAttack||e.push(r)}if(e.length>=1){e.forEach((e=>{"attack"===e.type?e.score=1*e.damage:"move"===e.type&&e.nextMoveAttack?e.score=.7*e.damage:e.score=.5}));let t=e[0];if(e.forEach((e=>{e.score>t.score&&(t=e)})),"attack"===t.type){const e=this.characterByCellAndTeam(t.attacker.position);this.selectCharacter(e),this.attack(e,this.characterByCellAndTeam(t.target.position)).then((()=>{this.gameLoop()}))}else if("move"===t.type){const e=this.characterByCellAndTeam(t.character.position);this.selectCharacter(e),this.moveCharacter(e.character,t.moveIndex),this.gameLoop()}}else this.gameLoop()}visualResponse(e){const t={cursors:"auto",color:null};return this.characterByCellAndTeam(e,"bot")&&this.attackIsPossiable(this.selectedCharacter.character,this.selectedCharacter.position,e)?(t.cursors=b,t.color="red"):this.characterByCellAndTeam(e,"player")?(t.cursors=f,t.color="yellow"):this.moveIsPossiable(this.selectedCharacter.character,e)&&!this.characterByCellAndTeam(e,"bot")?(t.cursors=f,t.color="green"):(t.cursors=w,t.color=null),t}static showCharacterStats(e){return`${String.fromCodePoint(127894)}${e.level}  ${String.fromCodePoint(9876)}${e.attack}  ${String.fromCodePoint(128737)}${e.defence}  ${String.fromCodePoint(10084)}${e.health}`}characterByCellAndTeam(e,t){return t?this.gameState.positions.find((a=>a.position===e&&a.character.teamName===t)):this.gameState.positions.find((t=>t.position===e))}selectCharacter(e){this.gamePlay.selectCell(e.position),this.selectedCharacter=e}deselectCharacter(e){this.gamePlay.deselectCell(e),this.selectedCharacter=null}moveIsPossiable(e,t){const a=e.moveDistance,s=Math.abs(t%this.gamePlay.boardSize-e.position%this.gamePlay.boardSize),i=Math.abs(Math.trunc(t/this.gamePlay.boardSize)-Math.trunc(e.position/this.gamePlay.boardSize));return(0===s||0===i)&&s<=a&&i<=a||s<=a&&i<=a&&0===Math.abs(i-s)}moveCharacter(e,t){this.moveIsPossiable(e,t)?(this.gamePlay.deselectCell(this.selectedCharacter.position),this.gamePlay.deselectCell(t),this.selectedCharacter.position=t,this.selectedCharacter.character.position=t,this.selectedCharacter=null):1===this.selectedCharacter.character.moveDistance?n.showMessage(`Персонаж ${this.selectedCharacter.character.type} может передвигаться по горизинтали, вертикали и диагонали и только на 1 клетку`):n.showMessage(`Персонаж ${this.selectedCharacter.character.type} может передвигаться по горизинтали, вертикали и диагонали и только на ${this.selectedCharacter.character.moveDistance} клетки`)}attackIsPossiable(e,t,a){const s=e.attackDistance,i=Math.abs(a%this.gamePlay.boardSize-t%this.gamePlay.boardSize),r=Math.abs(Math.trunc(a/this.gamePlay.boardSize)-Math.trunc(t/this.gamePlay.boardSize));return i<=s&&r<=s}static damage(e,t){return Math.max(e.attack-t.defence,.1*e.attack)}attack(e,t){const a=L.damage(e.character,t.character);return this.gamePlay.showDamage(t.position,a).then((()=>{t.character.health-=a,this.gamePlay.deselectCell(t.position),this.gamePlay.deselectCell(e.position),this.selectedCharacter=null,t.character.health<=0&&(this.gameState.positions.splice(this.gameState.positions.findIndex((e=>e===t)),1),t.character.health<=0&&(this.gameState.botTeam.deleteDead(),this.gameState.playerTeam.deleteDead()))}))}levelUp(){if(0===this.gameState.botTeam.members.length)if(this.gameState.level+=1,this.gameState.level>4)this.gameState.playerTeam.members.forEach((e=>{this.gameState.score+=e.health,this.gameState.totalScore+=this.gameState.score})),this.gameState.gameOver=!0;else{let e=0;2===this.gameState.level?(this.gameState.theme=g,e=1):3===this.gameState.level?(this.gameState.theme=p,e=2):4===this.gameState.level&&(this.gameState.theme=u,e=2),this.gameState.playerTeam.members.forEach((e=>{this.gameState.score+=e.health})),this.gameState.playerTeam.members.forEach((e=>e.levelUp())),this.gameState.positions=[],this.gameState.turn="player",this.gameState.playerTeam.addAll(v([i,t,s],this.gameState.level,e)),this.gameState.playerTeam.addTeamNameToCharacter("player"),this.gameState.botTeam.addAll(v([a,r,h],this.gameState.level,this.gameState.playerTeam.members.length)),this.gameState.botTeam.addTeamNameToCharacter("bot"),this.assignPositionsToTeams(),this.positionCharacters(),this.gamePlay.drawUi(this.gameState.theme),this.gamePlay.redrawPositions(this.gameState.positions)}}isGameOver(){this.gameState.playerTeam.members.length>0&&!0===this.gameState.gameOver?n.showMessage(`Поздравляем Вы победили!\n Ваш счёт: ${this.gameState.score} \n Ваш максимальный счёт: ${this.gameState.totalScore}`):0===this.gameState.playerTeam.members.length&&(this.gameState.gameOver=!0,n.showMessage("Вы проиграли\n Попробуйте еще раз"))}}const P=new n;P.bindToDOM(document.querySelector("#game-container"));const T=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new L(P,T).init()}();